---
import "../styles/global.css";
import Header from "../components/Header.astro";

const {
  headerTitle = "About Me",
  title = "Catherine — Portfolio",
  description = "Portfolio profesional",
} = Astro.props;
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title}</title>
    <link rel="icon" href="/favicon.png" type="image/svg+xml" />

    <meta name="description" content={description} />
  </head>

  <body class="bg-[#0b1324] text-slate-100 min-h-screen">
    <Header title={headerTitle} />

    <main>
      <slot />
    </main>

    <!-- MODAL GLOBAL DEL AVATAR (SIEMPRE CENTRADO) -->
    <div
      id="avatar-modal"
      class="fixed inset-0 z-[9999] hidden items-center justify-center
             bg-black/80 backdrop-blur-sm p-4"
      aria-hidden="true"
    >
      <div class="relative w-full max-w-4xl">
        <button
          id="avatar-close"
          aria-label="Cerrar"
          type="button"
          class="absolute -top-4 -right-4 grid h-10 w-10 place-items-center
                 rounded-full bg-black/60 text-white text-2xl
                 hover:bg-black/80 hover:text-yellow-300 transition"
        >
          ×
        </button>

        <img
          id="avatar-modal-img"
          src="/avatar-full.png"
          alt="Avatar completo de Catherine"
          class="w-full max-h-[85vh] object-contain rounded-2xl shadow-2xl
                 animate-[zoomIn_0.22s_ease-out]"
        />
      </div>
    </div>

    <!-- SCRIPT GLOBAL: MODAL + ANIMACIONES (replay al volver) -->
    <script is:inline>
      (() => {
        // ---------------------------
        // 1) MODAL AVATAR (robusto)
        // ---------------------------
        const modal = document.getElementById("avatar-modal");
        const closeBtn = document.getElementById("avatar-close");

        if (modal && closeBtn) {
          const open = () => {
            modal.classList.remove("hidden");
            modal.classList.add("flex");
            modal.setAttribute("aria-hidden", "false");
            document.body.style.overflow = "hidden";
          };

          const close = () => {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
            modal.setAttribute("aria-hidden", "true");
            document.body.style.overflow = "";
          };

          // ✅ Delegación: funciona aunque el botón esté en Home/About y se renderice después
          document.addEventListener("click", (e) => {
            const t = e.target;
            const btn = t?.closest?.("#avatar-btn");
            if (btn) open();
          });

          closeBtn.addEventListener("click", close);

          modal.addEventListener("click", (e) => {
            if (e.target === modal) close();
          });

          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") close();
          });
        }

        // -----------------------------------------
        // 2) ANIMACIONES HERO + ABOUT (con replay)
        // -----------------------------------------
        const runReveal = () => {
          const targets = document.querySelectorAll(".hero-anim, .about-anim");
          if (!targets.length) return;

          const replay = (el) => {
            el.classList.remove("is-visible");
            void el.offsetWidth; // reflow para reiniciar animación
            el.classList.add("is-visible");
          };

          const io = new IntersectionObserver(
            (entries) => {
              for (const entry of entries) {
                if (entry.isIntersecting) {
                  replay(entry.target);
                } else {
                  // ✅ al salir, resetea para que al volver re-anime
                  entry.target.classList.remove("is-visible");
                }
              }
            },
            { threshold: 0.35, rootMargin: "0px 0px -10% 0px" },
          );

          targets.forEach((el) => io.observe(el));
        };

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", runReveal);
        } else {
          runReveal();
        }
      })();
    </script>

    <style>
      @keyframes zoomIn {
        from {
          opacity: 0;
          transform: scale(0.96);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
    </style>
  </body>
</html>
